name: India TV EPG Update
permissions:
  contents: write

on:
  schedule:
    - cron: '30 18 * * *'  # 12:00 AM IST daily
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate India EPG (NO NPM REQUIRED)
        run: |
          # Indian TV Channels EPG - 7 days
          cat > epg_india.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <tv generator-info-name="India-TV-EPG" generator-info-url="https://github.com/Mobassar4u/IPTV-EPG-Grabber">
            <channel id="StarPlus.in">
              <display-name>Star Plus HD</display-name>
              <icon src="https://i.imgur.com/starplus.png"/>
            </channel>
            <channel id="ZeeTV.in">
              <display-name>Zee TV HD</display-name>
              <icon src="https://i.imgur.com/zeetv.png"/>
            </channel>
            <channel id="Colors.in">
              <display-name>Colors HD</display-name>
              <icon src="https://i.imgur.com/colors.png"/>
            </channel>
            <channel id="SonySAB.in">
              <display-name>Sony SAB HD</display-name>
              <icon src="https://i.imgur.com/sonysab.png"/>
            </channel>
          EOF

          # Add 7 days programs
          for day in {0..6}; do
            DATE=$(date -d "+$day days" +%Y%m%d)
            for CHANNEL in StarPlus.in ZeeTV.in Colors.in SonySAB.in; do
              case $CHANNEL in
                StarPlus.in) NAME="Star Plus HD" ;;
                ZeeTV.in) NAME="Zee TV HD" ;;
                Colors.in) NAME="Colors HD" ;;
                SonySAB.in) NAME="Sony SAB HD" ;;
              esac
              
              cat >> epg_india.xml << EOF
            <programme start="$DATE0000 +0530" stop="$DATE2359 +0530" channel="$CHANNEL">
              <title lang="en">$NAME Live</title>
              <desc lang="en">24x7 Live TV Broadcast - Entertainment Channel</desc>
              <category lang="en">Entertainment</category>
            </programme>
EOF
            done
          done

          cat >> epg_india.xml << 'EOF'
          </tv>
          EOF

          # Gzip compress
          gzip -9 -c epg_india.xml > epg_india.xml.gz
          rm epg_india.xml
      
      - name: Commit EPG
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add epg_india.xml.gz
          if ! git diff --staged --quiet; then
            git commit -m "Update India EPG $(date +'%Y-%m-%d')"
            git push
          else
            echo "No changes"
          fi
